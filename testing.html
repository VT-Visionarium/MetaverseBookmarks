<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bookmarking – Euclidean + Angular Accuracy</title>

  <!-- X3DOM runtime -->
  <script src="https://www.x3dom.org/download/1.8.2/x3dom.js"></script>
  <link rel="stylesheet" href="https://www.x3dom.org/download/1.8.2/x3dom.css" />

  <style>
    body{margin:0;padding:20px;background:#f4f4f4;text-align:center;font-family:Arial,Helvetica,sans-serif}
    x3d{width:900px;height:600px;border:2px solid #000;margin:0 auto 20px}
    button{margin:5px;padding:10px 15px;font-size:14px;cursor:pointer;border:none;border-radius:5px;
           background:#007bff;color:#fff;transition:background .3s}
    button:hover{background:#0056b3}
    .controls{position:absolute;top:95%;left:50%;transform:translate(-50%,-50%);
              text-align:center;max-width:450px;background:rgba(255,255,255,.85);
              padding:15px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:999}
    textarea{width:320px;height:100px;margin-top:10px;padding:5px;border:1px solid #ccc;
             border-radius:5px;font-family:monospace;font-size:12px;resize:none}
    #errorContainer{margin-top:10px;font-weight:bold;color:#d9534f}
    /* modal styles (unchanged) */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
           overflow:auto;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:10px;width:80%;
                   max-width:600px;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}
    .modal-content textarea{width:100%;height:300px;font-family:monospace;font-size:13px;padding:10px}
    .close-btn{position:absolute;top:10px;right:15px;color:#aaa;font-size:24px;font-weight:bold;cursor:pointer}
    .close-btn:hover{color:#000}
    #thumbnailPreview,#applyModalThumbnail{display:block;max-width:300px;margin-top:10px;border:1px solid #ccc}
    #applyModal .modal-content button{width:100px}
  </style>
</head>

<body>
  <h1 style="margin:20px 0;font-size:24px;color:#333">X3D Bookmarking Example with Roanoke City Model</h1>

  <!-- 3-D SCENE -->
  <x3d id="x3dElement">
    <scene>
      <WorldInfo title="Roanoke City Model" info="Built 2025, (c) Virginia Tech"
                 ageRestriction="18" license="CC-BY-4.0"></WorldInfo>

      <Background backUrl="nz.png" bottomUrl="ny.png" frontUrl="pz.png"
                  leftUrl="nx.png" rightUrl="px.png" topUrl="py.png"></Background>

      <Viewpoint DEF="AnimatedViewpoint"
                 position="947.60547 358.48150 114.24887"
                 orientation="-0.12102 0.99012 0.07078 1.38605"
                 description="Animated Street View"></Viewpoint>

      <Inline url="./3d_file/test.x3d"></Inline>

      <Transform translation="0 270 0">
        <Shape>
          <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
          <IndexedFaceSet coordIndex="0 1 2 3 -1" solid="false">
            <Coordinate point="-5000 0 -5000  5000 0 -5000  5000 0 5000  -5000 0 5000"></Coordinate>
          </IndexedFaceSet>
        </Shape>
      </Transform>

      <!-- simple animation plumbing -->
      <TimeSensor DEF="SceneTimer" loop="false"></TimeSensor>
      <PositionInterpolator DEF="ScenePositionInterp"></PositionInterpolator>
      <OrientationInterpolator DEF="SceneOrientationInterp"></OrientationInterpolator>
      <ROUTE fromNode="SceneTimer"          fromField="fraction_changed" toNode="ScenePositionInterp"    toField="set_fraction"></ROUTE>
      <ROUTE fromNode="SceneTimer"          fromField="fraction_changed" toNode="SceneOrientationInterp" toField="set_fraction"></ROUTE>
      <ROUTE fromNode="ScenePositionInterp" fromField="value_changed"    toNode="AnimatedViewpoint"      toField="set_position"></ROUTE>
      <ROUTE fromNode="SceneOrientationInterp" fromField="value_changed" toNode="AnimatedViewpoint"      toField="set_orientation"></ROUTE>
    </scene>
  </x3d>

  <!-- UI -->
  <div class="controls">
    <button onclick="generateBookmark()">Generate Bookmark</button>
    <button onclick="applyBookmark()">Apply Bookmark</button><br>
    <textarea id="bookmarkData" placeholder="Bookmark JSON here…"></textarea>

    <!-- NEW: positional & angular error read-out -->
    <div id="errorContainer">Error — distance: —  |  angle: —</div>
  </div>

  <!-- modals (unchanged markup) -->
  <div id="bookmarkModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2>Generated Bookmark</h2>
      <textarea readonly id="bookmarkModalText"></textarea>
      <p id="copyStatus" style="color:green;margin-top:10px;font-weight:bold"></p>
      <img id="thumbnailPreview" alt="Thumbnail Preview">
    </div>
  </div>

  <div id="applyModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeApplyModal()">&times;</span>
      <h2>Preview Bookmark</h2>
      <img id="applyModalThumbnail" alt="Bookmark thumbnail preview">
      <div style="margin-top:20px">
        <button onclick="confirmApply()">Apply</button>
        <button onclick="closeApplyModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /* ───────── helpers ───────── */

    const RAD2DEG = 180 / Math.PI;

    function getRuntime(){ return document.getElementById("x3dElement").runtime; }

    // axis-angle → quaternion  {x,y,z,w}
    function axisAngleToQuat(ax, ay, az, angle){
      const len = Math.hypot(ax, ay, az) || 1;
      const s   = Math.sin(angle / 2) / len;
      return {x: ax * s, y: ay * s, z: az * s, w: Math.cos(angle / 2)};
    }

    // compute distance and angular error & write to UI
    function showError(expectedCam){
      const runtime = getRuntime();

      /* position error */
      const pos    = runtime.viewMatrix().inverse().e3();    // SFVec3f
      const dx     = pos.x - expectedCam.position[0];
      const dy     = pos.y - expectedCam.position[1];
      const dz     = pos.z - expectedCam.position[2];
      const dist   = Math.hypot(dx, dy, dz);                 // metres

      /* orientation error */
      // actual quaternion from view matrix
      const qAct   = new x3dom.fields.Quaternion();
      qAct.setValue(runtime.viewMatrix().inverse());
      // expected quaternion from bookmark axis-angle
      const eo = expectedCam.orientation;
      const qExp = axisAngleToQuat(eo[0], eo[1], eo[2], eo[3]);

      const dot = Math.abs(qAct.x*qExp.x + qAct.y*qExp.y + qAct.z*qExp.z + qAct.w*qExp.w);
      const ang = 2 * Math.acos(Math.min(1, dot)) * RAD2DEG; // degrees

      document.getElementById("errorContainer").textContent =
        `Error — distance: ${dist.toFixed(3)} m  |  angle: ${ang.toFixed(2)} °`;
    }

    /* ───────── modal utils ───────── */

    function closeModal(){
      document.getElementById("bookmarkModal").style.display="none";
      document.getElementById("copyStatus").textContent="";
    }
    function closeApplyModal(){
      document.getElementById("applyModal").style.display="none";
      window._currentBookmark=null;
    }

    /* ───────── thumbnail helper ───────── */

    function compressDataURI(dataURI,maxW=300,q=.7){
      return new Promise(res=>{
        const img=new Image();
        img.onload=()=>{
          const scale=maxW/img.width;
          const cvs=document.createElement("canvas");
          cvs.width=maxW; cvs.height=img.height*scale;
          cvs.getContext("2d").drawImage(img,0,0,cvs.width,cvs.height);
          res(cvs.toDataURL("image/jpeg",q));
        };
        img.src=dataURI;
      });
    }

    /* ───────── bookmark generation ───────── */

    async function generateBookmark(){
      const rt=getRuntime();
      const vpM = rt.viewMatrix().inverse();
      const pos = vpM.e3();
      const quat= new x3dom.fields.Quaternion();
      quat.setValue(vpM);
      const [ax,ay,az,ang] = quat.toAxisAngle();

      const vp   = rt.viewpoint();
      const fov  = vp.getFieldOfView();
      const zN   = vp.getNear();
      const zF   = vp.getFar();

      const navT = rt.navigationType();
      const navS = rt.speed();

      const wi=document.querySelector("WorldInfo");
      const meta={
        title: wi?.getAttribute("title")??"",
        info:  wi?.getAttribute("info")??"",
        ageRestriction: wi?.getAttribute("ageRestriction")??"none",
        licenses: wi?.getAttribute("license")??""
      };

      const thumbURI= await compressDataURI(rt.getScreenshot());

      const bookmark={
        camera:{
          position:[pos.x,pos.y,pos.z],
          orientation:[ax,ay,az,ang],
          fieldOfView:fov,zNear:zN,zFar:zF
        },
        navigation:{type:navT,speed:navS},
        metadata:{
          annotation:"Generated viewpoint",
          timestamp:new Date().toISOString(),
          author:"User",
          application:"X3DOM Bookmarking v1.3",
          thumbnail:thumbURI,
          licenses:meta.licenses,
          ageRestriction:meta.ageRestriction,
          scene:{title:meta.title,info:meta.info}
        }
      };

      const str=JSON.stringify(bookmark,null,2);
      document.getElementById("bookmarkData").value       =str;
      document.getElementById("bookmarkModalText").value  =str;
      document.getElementById("thumbnailPreview").src     =thumbURI;
      document.getElementById("bookmarkModal").style.display="block";

      navigator.clipboard.writeText(str)
        .then(()=>document.getElementById("copyStatus").textContent="✅ Bookmark copied!")
        .catch(()=>document.getElementById("copyStatus").textContent="⚠️ Copy failed.");
    }

    /* ───────── bookmark application ───────── */

    function applyBookmark(){
      const json=document.getElementById("bookmarkData").value;
      try{
        const bm=JSON.parse(json);
        window._currentBookmark=bm;
        if(bm.metadata?.thumbnail)
          document.getElementById("applyModalThumbnail").src=bm.metadata.thumbnail;
        document.getElementById("applyModal").style.display="block";
      }catch(e){
        console.error(e);
        alert("Invalid bookmark data!");
      }
    }

    function confirmApply(){
      const bm=window._currentBookmark;
      if(!bm)return closeApplyModal();

      const rt=getRuntime();
      const cam=bm.camera;

      const vp=document.createElement("Viewpoint");
      vp.setAttribute("position",    cam.position.join(" "));
      vp.setAttribute("orientation", cam.orientation.join(" "));
      vp.setAttribute("fieldOfView", cam.fieldOfView);
      vp.setAttribute("zNear",       cam.zNear);
      vp.setAttribute("zFar",        cam.zFar);
      document.querySelector("scene").appendChild(vp);

      // wait one frame, bind, then measure errors
      rt.exitFrame=()=>{
        vp.setAttribute("bind","true");
        rt.exitFrame=()=>{};
        setTimeout(()=>showError(cam),0);  // next micro-task
      };

      if(bm.navigation){
        rt.navigationType(bm.navigation.type);
        rt.speed(bm.navigation.speed);
      }

      closeApplyModal();
      alert("✅ Bookmark applied!");
    }

    /* ───────── close modals on backdrop click ───────── */

    window.onclick=e=>{
      if(e.target===document.getElementById("bookmarkModal"))closeModal();
      if(e.target===document.getElementById("applyModal"))   closeApplyModal();
    };
  </script>
</body>
</html>
