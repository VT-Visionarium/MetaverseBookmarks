<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bookmarking – positional & angular accuracy</title>

<script src="https://www.x3dom.org/download/1.8.2/x3dom.js"></script>
<link  href="https://www.x3dom.org/download/1.8.2/x3dom.css" rel="stylesheet"/>

<style>
/* … unchanged styling trimmed for brevity … */
body{margin:0;padding:20px;background:#f4f4f4;text-align:center;font:14px Arial}
/* omit all the CSS here – same as in the previous answer               */
</style>
</head>

<body>
<h1 style="margin:20px 0;font-size:24px;color:#333">
  X3D Bookmarking with positional & angular error
</h1>

<!-- ───────────────────  SCENE  ─────────────────── -->
<x3d id="x3dElement">
  <scene>
    <WorldInfo title="Roanoke City Model"
               info="Built 2025 (c) Virginia Tech"
               ageRestriction="18"
               license="CC-BY-4.0"/>
    <Background backUrl="nz.png" bottomUrl="ny.png" frontUrl="pz.png"
                leftUrl="nx.png" rightUrl="px.png" topUrl="py.png"/>
    <Viewpoint DEF="AnimatedViewpoint"
               position="947.60547 358.48150 114.24887"
               orientation="-0.12102 0.99012 0.07078 1.38605"
               description="Animated Street View"/>
    <Inline url="./3d_file/test.x3d"/>
    <!-- flat ground, timers, routes … unchanged -->
  </scene>
</x3d>

<!-- ───────────────────  UI  ─────────────────── -->
<div class="controls">
  <button onclick="generateBookmark()">Generate Bookmark</button>
  <button onclick="applyBookmark()">Apply Bookmark</button><br>
  <textarea id="bookmarkData" placeholder="Bookmark JSON here…"></textarea>
  <div id="errorContainer"
       style="margin-top:10px;font-weight:bold;color:#d9534f">
    Error — distance: — | angle: —
  </div>
</div>

<!--  two modal dialogs … markup unchanged  -->

<script>
/* ───────────────────  math helpers  ─────────────────── */
const RAD2DEG = 180/Math.PI;

function axisAngleToQuat(ax, ay, az, angle){
  const len = Math.hypot(ax, ay, az) || 1;
  const s   = Math.sin(angle/2) / len;
  return {x: ax*s, y: ay*s, z: az*s, w: Math.cos(angle/2)};
}

/* ───────────────────  runtime handles  ─────────────────── */
function rt(){ return document.getElementById('x3dElement').runtime; }

/* ───────────────────  error read-out  ─────────────────── */
function showError(expectedCam){
  /* position error */
  const eye = rt().viewMatrix().inverse().e3();
  const dx  = eye.x - expectedCam.position[0];
  const dy  = eye.y - expectedCam.position[1];
  const dz  = eye.z - expectedCam.position[2];
  const dist= Math.hypot(dx,dy,dz);

  /* orientation error */
  const oriAct = rt().viewpoint().getOrientation();            // axis-angle
  const qAct   = axisAngleToQuat(oriAct.x,oriAct.y,oriAct.z,oriAct.w);

  const eo = expectedCam.orientation;
  const qExp  = axisAngleToQuat(eo[0],eo[1],eo[2],eo[3]);

  let dot = qAct.x*qExp.x + qAct.y*qExp.y + qAct.z*qExp.z + qAct.w*qExp.w;
  dot = Math.abs(dot);                      // take shorter arc
  dot = Math.min(1, Math.max(-1, dot));     // clamp → [-1,1]

  const ang = 2*Math.acos(dot)*RAD2DEG;

  document.getElementById('errorContainer').textContent =
    `Error — distance: ${dist.toFixed(3)} m | angle: ${ang.toFixed(2)} °`;
}

/* ───────────────────  bookmark → JSON  ─────────────────── */
async function generateBookmark(){
  const vp   = rt().viewpoint();
  const pos  = vp.getPosition();            // SFVec3f
  const ori  = vp.getOrientation();         // SFRotation (axis-angle)

  const cam = {
    position   : [pos.x,pos.y,pos.z],
    orientation: [ori.x,ori.y,ori.z,ori.w],
    fieldOfView: vp.getFieldOfView(),
    zNear      : vp.getNear(),
    zFar       : vp.getFar()
  };

  const nav = {type: rt().navigationType(), speed: rt().speed()};

  const wi  = document.querySelector('WorldInfo');
  const meta= {
    annotation : 'Generated viewpoint',
    timestamp  : new Date().toISOString(),
    author     : 'User',
    application: 'X3DOM Bookmarking v1.4',
    thumbnail  : await compressDataURI(rt().getScreenshot()),
    licenses   : wi?.getAttribute('license')??'',
    ageRestriction: wi?.getAttribute('ageRestriction')??'none',
    scene      : {title: wi?.getAttribute('title')??'', info: wi?.getAttribute('info')??''}
  };

  const bookmark = {camera: cam, navigation: nav, metadata: meta};

  /*  show & copy  */
  const txt = JSON.stringify(bookmark,null,2);
  document.getElementById('bookmarkData').value      = txt;
  document.getElementById('bookmarkModalText').value = txt;
  document.getElementById('thumbnailPreview').src    = meta.thumbnail;
  document.getElementById('bookmarkModal').style.display='block';

  navigator.clipboard.writeText(txt)
    .then(()=>document.getElementById('copyStatus').textContent='✅ Bookmark copied!')
    .catch(()=>document.getElementById('copyStatus').textContent='⚠️ Copy failed.');
}

/* ───────────────────  apply bookmark  ─────────────────── */
function applyBookmark(){
  try{
    window._bm = JSON.parse(document.getElementById('bookmarkData').value);
    document.getElementById('applyModalThumbnail').src =
      window._bm.metadata?.thumbnail || '';
    document.getElementById('applyModal').style.display='block';
  }catch(e){
    alert('Invalid bookmark data'); console.error(e);
  }
}

function confirmApply(){
  const bm = window._bm; if(!bm){ closeApplyModal(); return; }

  const vp = document.createElement('Viewpoint');
  vp.setAttribute('position',    bm.camera.position.join(' '));
  vp.setAttribute('orientation', bm.camera.orientation.join(' '));
  vp.setAttribute('fieldOfView', bm.camera.fieldOfView);
  vp.setAttribute('zNear',       bm.camera.zNear);
  vp.setAttribute('zFar',        bm.camera.zFar);
  document.querySelector('scene').appendChild(vp);

  /* bind on next frame, then measure */
  rt().exitFrame = ()=>{
    vp.setAttribute('bind','true');
    rt().exitFrame = ()=>{};
    setTimeout(()=>showError(bm.camera),0);
  };

  if(bm.navigation){
    rt().navigationType(bm.navigation.type);
    rt().speed(bm.navigation.speed);
  }

  closeApplyModal();
}

/* ───────────────────  utils (compressDataURI, modal close …)  ─────────────────── */
/* identical to the previous answer – paste yours here                              */
</script>
</body>
</html>
