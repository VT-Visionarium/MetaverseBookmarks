<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X3D Bookmarking – accuracy read-out</title>

  <!-- X3DOM runtime -->
  <script src="https://www.x3dom.org/download/1.8.2/x3dom.js"></script>
  <link  rel="stylesheet" href="https://www.x3dom.org/download/1.8.2/x3dom.css"/>

  <style>
    body{margin:0;padding:20px;text-align:center;font-family:Arial,Helvetica,sans-serif;background:#f4f4f4}
    x3d {width:900px;height:600px;border:2px solid #000;margin:0 auto 20px}
    button{margin:5px;padding:10px 15px;font-size:14px;cursor:pointer;border:none;border-radius:5px;
           background:#007bff;color:#fff;transition:background .3s}
    button:hover{background:#0056b3}
    .controls{position:absolute;top:95%;left:50%;transform:translate(-50%,-50%);
              max-width:420px;text-align:center;background:rgba(255,255,255,.85);
              padding:15px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:999}
    textarea{width:300px;height:100px;margin-top:10px;padding:5px;border:1px solid #ccc;border-radius:5px;
             font-family:monospace;font-size:12px;resize:none}
    #errorContainer{margin-top:10px;font-weight:bold;color:#d9534f;text-align:left}
    #errorContainer span{display:block}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;
           background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:10px;width:80%;max-width:600px;
                   box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}
    .modal-content textarea{width:100%;height:300px;font-family:monospace;font-size:13px;padding:10px}
    .close-btn{position:absolute;top:10px;right:15px;color:#aaa;font-size:24px;font-weight:bold;cursor:pointer}
    .close-btn:hover{color:#000}
    #thumbnailPreview,#applyModalThumbnail{display:block;max-width:300px;margin-top:10px;border:1px solid #ccc}
    #applyModal .modal-content button{width:100px}
  </style>
</head>

<body>
  <h1 style="margin:20px 0;font-size:24px;color:#333">
    X3D Bookmarking Example with Roanoke City Model
  </h1>

  <!-- ────────── 3-D scene ────────── -->
  <x3d id="x3dElement">
    <scene>
      <WorldInfo title="Roanoke City Model" info="Built 2025, (c) Virginia Tech"
                 ageRestriction="18" license="CC-BY-4.0"></WorldInfo>

      <Background backUrl="nz.png" bottomUrl="ny.png" frontUrl="pz.png"
                  leftUrl="nx.png" rightUrl="px.png" topUrl="py.png"></Background>

      <Viewpoint DEF="AnimatedViewpoint"
                 position="947.60547 358.48150 114.24887"
                 orientation="-0.12102 0.99012 0.07078 1.38605"
                 description="Animated Street View"></Viewpoint>

      <Inline url="./3d_file/test.x3d"></Inline>

      <Transform translation="0 270 0">
        <Shape>
          <Appearance><Material diffuseColor="0.5 0.5 0.5"/></Appearance>
          <IndexedFaceSet coordIndex="0 1 2 3 -1" solid="false">
            <Coordinate point="-5000 0 -5000  5000 0 -5000  5000 0 5000  -5000 0 5000"/>
          </IndexedFaceSet>
        </Shape>
      </Transform>

      <TimeSensor DEF="SceneTimer" loop="false"/>
      <PositionInterpolator    DEF="ScenePositionInterp"/>
      <OrientationInterpolator DEF="SceneOrientationInterp"/>

      <ROUTE fromNode="SceneTimer"          fromField="fraction_changed" toNode="ScenePositionInterp"   toField="set_fraction"/>
      <ROUTE fromNode="SceneTimer"          fromField="fraction_changed" toNode="SceneOrientationInterp"toField="set_fraction"/>
      <ROUTE fromNode="ScenePositionInterp" fromField="value_changed"    toNode="AnimatedViewpoint"     toField="set_position"/>
      <ROUTE fromNode="SceneOrientationInterp" fromField="value_changed" toNode="AnimatedViewpoint"     toField="set_orientation"/>
    </scene>
  </x3d>

  <!-- ────────── controls ────────── -->
  <div class="controls">
    <button onclick="generateBookmark()">Generate Bookmark</button>
    <button onclick="applyBookmark()">Apply Bookmark</button><br>
    <textarea id="bookmarkData" placeholder="Bookmark JSON here…"></textarea>

    <!-- live accuracy read-out -->
    <div id="errorContainer">
      <span>Position Error: —</span>
      <span>FOV Δ: —</span>
      <span>zNear Δ: —</span>
      <span>zFar Δ: —</span>
    </div>
  </div>

  <!-- ────────── modals ────────── -->
  <div id="bookmarkModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2>Generated Bookmark</h2>
      <textarea readonly id="bookmarkModalText"></textarea>
      <p id="copyStatus" style="color:green;margin-top:10px;font-weight:bold"></p>
      <img id="thumbnailPreview" alt="Thumbnail Preview">
    </div>
  </div>

  <div id="applyModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeApplyModal()">&times;</span>
      <h2>Preview Bookmark</h2>
      <img id="applyModalThumbnail" alt="Bookmark thumbnail preview">
      <div style="margin-top:20px">
        <button onclick="confirmApply()">Apply</button>
        <button onclick="closeApplyModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ────────── JavaScript ────────── -->
  <script>
    /* small helpers */
    const $  = id => document.getElementById(id);
    const rt = () => $("x3dElement").runtime;

    /* ─── accuracy read-out ─── */
    function showErrors(expectedCam){
      /* 1 – position error */
      const eye = rt().viewMatrix().inverse().e3();
      const dx = eye.x - expectedCam.position[0],
            dy = eye.y - expectedCam.position[1],
            dz = eye.z - expectedCam.position[2];
      const posErr = Math.hypot(dx,dy,dz);

      /* 2 – FOV / zNear / zFar differences */
      const vp = rt().viewpoint();
      const fovErr   = Math.abs(vp.getFieldOfView() - expectedCam.fieldOfView);
      const zNearErr = Math.abs(vp.getNear()        - expectedCam.zNear);
      const zFarErr  = Math.abs(vp.getFar()         - expectedCam.zFar);

      /* 3 – update UI */
      $("errorContainer").innerHTML =
        `<span>Position Error: ${posErr.toFixed(3)} m</span>`+
        `<span>FOV Δ: ${(fovErr*180/Math.PI).toFixed(3)}°</span>`+
        `<span>zNear Δ: ${zNearErr.toFixed(4)}</span>`+
        `<span>zFar Δ: ${zFarErr.toFixed(4)}</span>`;
    }

    /* ─── modal helpers ─── */
    function closeModal(){ $("bookmarkModal").style.display="none"; $("copyStatus").textContent=""; }
    function closeApplyModal(){ $("applyModal").style.display="none"; window._currentBookmark=null; }

    /* ─── thumbnail compression ─── */
    function compressDataURI(uri,maxWidth=300,q=.7){
      return new Promise(res=>{
        const img=new Image();
        img.onload=()=>{
          const s=maxWidth/img.width, c=document.createElement("canvas");
          c.width=maxWidth; c.height=img.height*s;
          c.getContext("2d").drawImage(img,0,0,c.width,c.height);
          res(c.toDataURL("image/jpeg",q));
        };
        img.src=uri;
      });
    }

    /* ─── generate bookmark ─── */
    async function generateBookmark(){
      const viewMatInv = rt().viewMatrix().inverse();
      const pos = viewMatInv.e3();
      const quat = new x3dom.fields.Quaternion(); quat.setValue(viewMatInv);
      const axisAngle = quat.toAxisAngle();          // [axis,angle]
      const axis = axisAngle[0], angle = axisAngle[1];

      const vp = rt().viewpoint();
      const bookmark = {
        camera:{
          position:[pos.x,pos.y,pos.z],
          orientation:[axis.x,axis.y,axis.z,angle],
          fieldOfView:vp.getFieldOfView(),
          zNear:vp.getNear(),
          zFar:vp.getFar()
        },
        navigation:{type:rt().navigationType(),speed:rt().speed()},
        metadata:{
          annotation:"Generated viewpoint",
          timestamp:new Date().toISOString(),
          author:"User",
          application:"X3DOM Bookmarking v1.3",
          thumbnail:await compressDataURI(rt().getScreenshot(),300,.7)
        }
      };

      const json = JSON.stringify(bookmark,null,2);
      $("bookmarkData").value = $("bookmarkModalText").value = json;
      $("thumbnailPreview").src = bookmark.metadata.thumbnail;
      $("bookmarkModal").style.display="block";

      navigator.clipboard.writeText(json)
        .then(()=>$("copyStatus").textContent="✅ Bookmark copied!")
        .catch(()=>$("copyStatus").textContent="⚠️ Copy failed.");
    }

    /* ─── apply bookmark ─── */
    function applyBookmark(){
      try{
        const bk = JSON.parse($("bookmarkData").value);
        window._currentBookmark = bk;
        if(bk.metadata?.thumbnail) $("applyModalThumbnail").src = bk.metadata.thumbnail;
        $("applyModal").style.display="block";
      }catch(e){ alert("Invalid bookmark data!"); }
    }

    function confirmApply(){
      const bk = window._currentBookmark; if(!bk) return closeApplyModal();

      /* create temp Viewpoint & bind */
      const vp = document.createElement("Viewpoint");
      vp.setAttribute("position"   , bk.camera.position.join(" "));
      vp.setAttribute("orientation", bk.camera.orientation.join(" "));
      vp.setAttribute("fieldOfView", bk.camera.fieldOfView);
      vp.setAttribute("zNear"      , bk.camera.zNear);
      vp.setAttribute("zFar"       , bk.camera.zFar);
      document.querySelector("scene").appendChild(vp);

      rt().exitFrame = ()=>{
        vp.setAttribute("bind","true");
        rt().exitFrame = ()=>{};
        /* one micro-task later, measure errors */
        setTimeout(()=>showErrors(bk.camera),0);
      };

      if(bk.navigation){
        rt().navigationType(bk.navigation.type);
        rt().speed(bk.navigation.speed);
      }

      closeApplyModal();
      alert("✅ Bookmark applied!");
    }

    /* close modals when clicking the backdrop */
    window.onclick = e=>{
      if(e.target===$("bookmarkModal")) closeModal();
      if(e.target===$("applyModal"))   closeApplyModal();
    };
  </script>
</body>
</html>
